<!doctype html>
<html>
<head>
  <title>Clementine Web Remote</title>
  <script type="text/javascript" src="/_ah/channel/jsapi"></script>
  <script type="text/javascript" src="/js/Long.min.js"></script>
  <script type="text/javascript" src="/js/ByteBuffer.min.js"></script>
  <script type="text/javascript" src="/js/ProtoBuf.min.js"></script>
</head>
<body>
  <script type="text/javascript">
    var id = '{{ id }}';
    var proto = dcodeIO.ProtoBuf.loadProtoFile('/proto/remotecontrolmessages.proto');
    var Message = proto.build('pb.remote.Message');
    var MsgType = proto.lookup('pb.remote.MsgType').build();

    var channel = new goog.appengine.Channel('{{ token }}');
    var socket = channel.open();
    socket.onopen = function() {
      window.console.log('open');
      document.getElementById('status').innerText = 'Connected';
    };
    socket.onmessage = function(message) {
      var id = message.data
      var request = new XMLHttpRequest;
      request.onload = function() {
        processMessage(this.responseText);
      }
      request.open('get', '/channel/remote/fetch/' + id);
      request.send();
    };
    socket.onerror = function() {
      window.console.log('error');
    };
    socket.onclose = function() {
      window.console.log('close');
      document.getElementById('status').innerText = 'Disconnected';
    };

    function processMessage(message) {
      var msg = Message.decode64(message);
      switch (msg.type) {
        case MsgType.CURRENT_METAINFO:
          updateMetadata(msg.response_current_metadata.song_metadata);
          break;

        default:
          break;
      }
    }

    function ping() {
      var request = new XMLHttpRequest;
      request.onload = function() {
        window.console.log(this.responseText);
      };
      request.open('post', '/channel/remote/push/' + id, true);
      request.send(JSON.stringify({'method': 'ping'}));
    }

    function playpause() {
      var request = new XMLHttpRequest;
      request.onload = function() {
        window.console.log(this.responseText);
      };
      request.open('post', '/channel/remote/push/' + id, true);
      request.send(JSON.stringify({'method': 'playpause'}));
    }

    function updateMetadata(songMetadata) {
      document.getElementById('title').innerText = songMetadata.title;
      document.getElementById('artist').innerText = songMetadata.artist;
      document.getElementById('album').innerText = songMetadata.album;

      var art = songMetadata.art;
      window.console.log(art);
      var bytes = new Uint8Array(art.toArrayBuffer());
      var blob = new Blob([bytes], {type: "image/jpeg"});
      var urlCreator = window.URL || window.webkitURL;
      var imageUrl = urlCreator.createObjectURL(blob);
      document.getElementById('cover').src = imageUrl;
    }

    function updateStatus(info) {
      document.getElementById('engine-status').innerText = info.state;
    }
  </script>

  <div>
    Clementine web remote
  </div>
  <div id="status">Disconnected</div>

  <button onclick="ping()">Ping</button>
  <button onclick="playpause()">Play/Pause</button>

  <div id="engine-status">Stopped</div>
  <div class="songinfo">
    <div id="title"></div>
    <div id="artist"></div>
    <div id="album"></div>
    <img id="cover">
  </div>
</body>
</html>
